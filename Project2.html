<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/default.min.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script>hljs.highlightAll();</script>
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      },
      options: {
        renderActions: {
          addMenu: []
        }
      },
      svg: {
        fontCache: 'global',
        scale: 1.0
      }
    };
    document.addEventListener("DOMContentLoaded", () => {
    const sidebar = document.querySelector('.sidebar');
    const main = document.querySelector('.main-content');
    const wrapper = document.createElement('div');
    wrapper.className = 'layout';

    sidebar.parentNode.insertBefore(wrapper, sidebar);
    wrapper.appendChild(sidebar);
    wrapper.appendChild(main);
  });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" async></script>
</head>

<body>
  <div class="sidebar">
    <img src="Logo_NS-blackboard-Expand.png" alt="Sidebar Image">
    <nav>
      <ul class="nav-menu">
        <li><a href="Welcome.html">Welcome to NFYK22003U</a></li>
        <li><a href="CourseInformation.html">Course Information</a></li>
        <li><a href="Schedule2025.html">Schedule 2025</a></li>
        <li><a href="MathsSpeedrun.html">Maths Speedrun</a></li>
        <li>
          <a href="Lecture1.html">Lecture 1</a></li>
          <ul class="sub-menu">
            <li><a href="Project1.html">Project 1 – Oxygen Budget</a></li>
          </ul>
          <li><a href="Lecture2.html">Lecture 2</a></li>
          <ul class="sub-menu">
            <li><a href="Project2.html">Project 2 – The Sverdrup Relation</a></li>
          </ul>
          <li><a href="Lecture3.html">Lecture 3</a></li>
          <li><a href="Lecture4.html">Lecture 4</a></li>
          <ul class="sub-menu">
            <li><a href="Project3.html">Project 3 – Western Boundary Currents</a></li>
          </ul>
          <li><a href="Lecture5.html">Lecture 5</a></li>
          <li><a href="Lecture6.html">Lecture 6</a></li>
          <li><a href="Lecture7.html">Lecture 7</a></li>
          <ul class="sub-menu">
            <li><a href="Project4.html">Project 4 – Shadow Zone</a></li>
          </ul>
          <li><a href="Lecture8.html">Lecture 8</a></li>
          <li><a href="Lecture9.html">Lecture 9</a></li>
          <ul class="sub-menu">
            <li><a href="Project5.html">Project 5 – Hadley Cell</a></li>
          </ul>
          <li><a href="Lecture10.html">Lecture 10</a></li>
          <ul class="sub-menu">
            <li><a href="Project6.html">Project 6 – Southern Ocean Winds and Overturning</a></li>
          </ul>
          <li><a href="Lecture11.html">Lecture 11</a></li>
          <li><a href="Lecture12.html">Lecture 12</a></li>
          <ul class="sub-menu">
            <li><a href="Project7.html">Project 7 – Oscillations</a></li>
          </ul>
          <li><a href="References.html">References</a></li>
        </li>
      </ul>
    </nav>
  </div>

  
  <div class="main-content">
    <h1>Project 2 – The Sverdrup Relation</h1>

    <p>Use the ACC setup of Veros to test the Sverdrup theory.<br><br>
      Show the model’s stream function and compare it to the theory’s.<br>
      Make sure the model is spun up, and be careful with the units.<br><br>
      Where does the model deviate from the theory and why?
      </p>


    <h2>Ocean Modelling with Veros</h2>

    <h3>Running Veros on ERDA</h3>

    <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">cd ~/erda_mount</code></pre>
      </div>
      <pre style="font-family: 'Courier New', Courier, monospace; color: #aaccee; background: transparent; border: none; padding: 1em 0; margin: 0;">/home/jovyan/erda_mount</pre>

      
      <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">!git clone https://github.com/team-ocean/veros.git -b v1.5.2</code></pre>
      </div>

      <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">cd veros</code></pre>
      </div>
      <pre style="font-family: 'Courier New', Courier, monospace; color: #aaccee; background: transparent; border: none; padding: 1em 0; margin: 0;">/home/jovyan/erda_mount/veros</pre>

      <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">conda env create -f conda-environment.yml</code></pre>
      </div>

      <p>Inside the ERDA Jupyter notebook, you cannot do conda activate veros normally, because Jupyter runs inside its own kernel.
        If you want to properly activate the Veros conda environment and run Veros, you must open a Terminal on ERDA.
        In the Terminal, type:
      </p>
      <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">conda activate veros</code></pre>
      </div>

      <p>To tell Veros what to do, you need to write a so-called <i>setup</i>, create your setups</p>
      <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">mkdir ~/vs-setups
cd ~/vs-setups
veros copy-setup global_4deg
cd global_4deg
</code></pre>
      </div>

      <p>Right now, your default <code>global_4deg.py</code> has <code>settings.runlen = 0</code>, which means "run for 0 seconds". Edit the setup file to actually run for longer</p>
      <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">settings.runlen = 86400 * 365 * 10  # 10 model years, = 10 years × 365 days × 86400 seconds/day</code></pre>
      </div>

      <p>Now run the simulation</p>
      <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">veros run global_4deg.py</code></pre>
      </div>
      <pre style="font-family: 'Courier New', Courier, monospace; color: #aaccee; background: transparent; border: none; padding: 1em 0; margin: 0;">veros run global_4deg.py
Importing core modules
 Using computational backend numpy on cpu
 Runtime settings are now locked

Running model setup
 removing an annual mean heat flux imbalance of 7.860702e-02 W/m^2
Initializing streamfunction method
Computing ILU preconditioner...
 Solving for boundary contribution by island 0
 Solving for boundary contribution by island 1
 Solving for boundary contribution by island 2
 Solving for boundary contribution by island 3
 Solving for boundary contribution by island 4
 Solving for boundary contribution by island 5
 Running diagnostic "averages" every 1.0 days
 Writing output for diagnostic "averages" every 1.0 years
 Running diagnostic "energy" every 1.0 days
 Writing output for diagnostic "energy" every 1.0 years
 Running diagnostic "overturning" every 1.0 days
 Writing output for diagnostic "overturning" every 1.0 years
 Writing output for diagnostic "snapshot" every 1.0 years
Diffusion grid factor delta_iso1 = 0.013376791936035174

Starting integration for 10.0 years
 Writing snapshot at 1.00 years                                                  
 Writing snapshot at 2.00 years                                                  
 Writing snapshot at 3.00 years                                                  
 Writing snapshot at 4.00 years                                                  
 Writing snapshot at 5.00 years                                                  
 Writing snapshot at 6.00 years                                                  
 Writing snapshot at 7.00 years                                                 
 Writing snapshot at 8.00 years                                                 
 Writing snapshot at 9.00 years                                                 
 Writing snapshot at 10.00 years                                                  
 Current iteration: 3600  (10.00/10.00y | 100.0% | 2.38m/(model year) | 0.0s left)
Integration done

Writing restart file global_4deg_3600.restart.h5</pre>

    <p>It should be noted that Veros cannot overwrite an existing file by default, so if you want to re-run the same script, do something like :</p>
        <div class="code-block">
      <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
      <pre><code class="language-python">rm -rf global_4deg
veros copy-setup global_4deg
cd global_4deg
</code></pre>
    </div>

    <div class="code-block">
      <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
      <pre><code class="language-python">rm global_4deg.*.nc global_4deg_*.restart.h5</code></pre>
    </div>

To generate new output filenames (e.g., <code>global_4deg_modified.averages.nc</code>, etc.), change the runtime <code>settings.identifier</code> string in your setup file such as <code>modify_global_4deg.py</code> to something like:
    <div class="code-block">
      <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
      <pre><code class="language-python">settings.identifier = "global_4deg_modified"</code></pre>
    </div>


    <p>After a successful run, Veros writes NetCDF files in the current folder <code>~/vs-setups/global_4deg/</code>.
        You will find files like:
        <code>global_4deg.snapshot.nc</code>,
        
        <code>global_4deg.averages.nc</code>,
        
        <code>global_4deg.energy.nc</code>, 
        
        <code>global_4deg.overturning.nc</code>,
        
        <code>global_4deg_0000.restart.h5</code>.
    
    In your notebook, you can load Veros output
    <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">import os
os.chdir("/home/jovyan/vs-setups/global_4deg")  # Go to correct directory

import xarray as xr
import matplotlib.pyplot as plt
import cmocean

ds = xr.open_dataset("global_4deg.snapshot.nc", engine="h5netcdf")

# Extract surface temperature
temp_surface = ds.temp.isel(Time=-1, zt=-1)

# Start plot
fig, ax = plt.subplots(figsize=(8, 5), facecolor="none", dpi=300)  # transparent background

# Plot with cmocean thermal colormap
p = temp_surface.plot.pcolormesh(
    ax=ax,
    cmap=cmocean.cm.thermal,
    add_colorbar=True,
    cbar_kwargs={"label": "Temperature (°C)", "orientation": "vertical"},
)

# Set color
text_color = "#d6ebff"
ax.set_title("Surface Temperature", color=text_color)
ax.set_xlabel("Longitude", color=text_color)
ax.set_ylabel("Latitude", color=text_color)

# Set tick params
ax.tick_params(axis="both", colors=text_color)

# Set axis spines color (frame lines)
for spine in ax.spines.values():
    spine.set_edgecolor(text_color)

# Set colorbar text and frame color
cbar = p.colorbar
cbar.ax.yaxis.label.set_color(text_color)
cbar.ax.tick_params(colors=text_color)
# Set colorbar outline (the frame)
cbar.outline.set_edgecolor(text_color)

# Transparent background
ax.set_facecolor("none")
fig.patch.set_alpha(0.0)  # fully transparent

fig.savefig("surface_temperature.png", dpi=300, bbox_inches="tight", transparent=True)
# Show plot
plt.show()</code></pre>
      </div>
      <img src="Figures/Project2_VerosExampleTemp.png" alt="VerosExampleTemp.png" style="margin-top: 1.5em; border: 1px solid #3c5c78; border-radius: 6px; max-width: 100%; display: block;">
    </p>

    <Strong>Now let's start with your own script</Strong>

    <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">cd ~/vs-setups/
mkdir acc_basic
cd acc_basic
</code></pre>
      </div>

      <p>Save the script <code>acc_basic.py</code> inside this folder, if you are using Jupyter Notebook, in a notebook cell, write:</p>
      <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">%%writefile acc_basic/acc_basic.py

from veros import VerosSetup, veros_routine
from veros.variables import allocate, Variable
from veros.distributed import global_min, global_max
from veros.core.operators import numpy as npx, update, at
# (the rest of the script)
</code></pre>
      </div>

      <p>Then to run, your output NetCDF files will also be inside <code>~/vs-setups/acc_basic/</code>:</p>
      <div class="code-block">
        <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
        <pre><code class="language-python">conda activate veros
veros run acc_basic.py --force-overwrite
</code></pre>
      </div>
      <pre style="font-family: 'Courier New', Courier, monospace; color: #aaccee; background: transparent; border: none; padding: 1em 0; margin: 0;">Importing core modules
 Using computational backend numpy on cpu
 Runtime settings are now locked

Running model setup
Initializing streamfunction method
Computing ILU preconditioner...
 Solving for boundary contribution by island 0
 Solving for boundary contribution by island 1
 Running diagnostic "averages" every 5.0 days
 Writing output for diagnostic "averages" every 1.0 years

Starting integration for 50.7 years
 Current iteration: 36500 (50.69/50.69y | 100.0% | 29.55s/(model year) | 0.0s left)
Integration done

Writing restart file acc_sverdrup_36500.restart.h5</pre>

<p>There are many predefined setups in Veros, so you will not have to write one from scratch, you can also do</p>
<div class="code-block">
  <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
  <pre><code class="language-python">veros copy-setup acc</code></pre>
        </div>

<p>If you want a fresh copy, remove the existing <code>acc/</code> folder and copy again:</p>
<div class="code-block">
  <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
  <pre><code class="language-python">rm -rf acc
veros copy-setup acc</code></pre>
        </div>

<p>Then just go inside the <code>acc/</code> folder and run it, make sure the file path is correct</p>
<div class="code-block">
  <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
  <pre><code class="language-python">veros run acc/acc.py</code></pre>
        </div>


<h3>Load output and inspect \(\Psi\)</h3>

<p>Plot the 1D curve of the maximum value of $\Psi$ over time and check whether the model is fully spun up, ie. whether it has reached the steady state.</p>
<div class="code-block">
  <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
  <pre><code class="language-python">ds['psi'].max(dim=("xu", "yu")).plot()</code></pre>
        </div>

<p>If you are satisfied with the plot, go ahead and re-define 'ds' as the last model year of the original output set.</p>
<div class="code-block">
  <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
  <pre><code class="language-python">ds = ds.isel(Time=-1)</code></pre>
        </div>

<h3>Compute wind stress curl</h3>
<p>Define $\rho_0$, $\Omega$ and the Earth's radius, $a$</p>
<div class="code-block">
<button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
<pre><code class="language-python">#rho_0 = 
#omega = 
#earth_radius = 
#beta = 2 * omega * np.cos(np.radians(ds['yu'].values)) / earth_radius</code></pre>
</div>

<p>Now you need to export and define some variables from the output set. Namely, the output barotropic stream function to compare with the computed $\Psi_{Sv}$, and the grid coordinates $x$ and $y$.
  The <code>values()</code> method is one of the <a href="https://www.w3schools.com/python/python_ref_dictionary.asp">Python Dictionary Methods</a>, it returns a list of all the values in the dictionary. The view object contains the values of the dictionary, as a list.
  Define variables <code>psi</code>, <code>yt</code> and <code>xt</code> from <code>ds</code>.</p>
<div class="code-block">
  <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
  <pre><code class="language-python">#course = {
  #"university": "UCPH",
  #"name": "Computational Atmosphere and Ocean Dynamics",
  #"code": "NFYK22003U",
  #"year": 2025
#}

#x = course.values()

#print(x)</code></pre>
  </div>

<p>Correct the definitions below to express $dx$ and $dy$ in meters</p>
<div class="code-block">
  <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
  <pre><code class="language-python">dx = (xt[1] - xt[0]) * np.cos(np.radians(yt))
dy = (yt[1] - yt[0])</code></pre>
  </div>


<p>The following two functions can integrate and compute the gradient of an array. 

  The function <code>integrate</code> takes 3 arguments: the array you wish to integrate over, the direction (either $x$ or $y$), and a boolean variable which, when set to <code>True</code>, will flip the limits of the integral. For example, if we have:
  
  \[
  \int^{x_1}_{x_0} f(x,y) dx,
  \]
  
  setting the variable <code>reverse=True</code> will result in the function output $\int_{x_1}^{x_0} f(x,y) dx$.
  
  The function <code>gradient</code> takes 2 arguments: the array you wish to differentiate over, and the direction (either $x$ or $y$). Let the imput function be $g(x,y)$ and the direction $x$, the function output is then:
  
  \[
  \frac{\partial}{\partial x} g(x,y)
  \]
  <div class="code-block">
    <button class="copy-btn" onclick="copyToClipboard(this)">Copy</button>
    <pre><code class="language-python">def integrate(q, direction, reverse=False):
    if direction == 'x':
        dxi = dx[:, np.newaxis]
        axis = 1
        
        if reverse:
            q = q[:, ::-1]
            
    elif direction == 'y':
        dxi = dy
        axis = 0
        
        if reverse:
            q = q[::-1]
            
    else:
        raise ValueError('direction must be "x" or "y"')
        
    out = np.nancumsum(q * dxi, axis=axis)
    out[np.isnan(q)] = np.nan
    
    if reverse:
        if direction == 'x':
            out = -out[:, ::-1]
        else:
            out = -out[::-1, :]
        
    return out


def gradient(q, direction):
    """Compute the gradient of a 2D variable on a C-grid"""
    if direction == 'x':
        arr_pad = np.pad(q, ([0], [1]), 'wrap')
        return (arr_pad[:, 2:] - arr_pad[:, 1:-1]) / dx[:, np.newaxis]

    elif direction == 'y':
        arr_pad = np.pad(q, ([1], [0]), 'constant', constant_values=np.nan)
        return (arr_pad[2:, :] - arr_pad[1:-1, :]) / dy

    raise ValueError('direction must be "x" or "y"')</code></pre>
  </div>

</p>Use a suitable function to compute $\nabla \times \tau$.
<i>Hint: The definition of a curl in 2D is $\nabla \times f(x,y) = \frac{\partial}{\partial x} f_y(x,y) - \frac{\partial}{\partial y} f_x(x,y)$</i>
<div class="code-block">
  <pre><code class="language-python"></code></pre>
  </div>

<p>Check your solution by ploting $\nabla \times \tau$. Does the calculated $\nabla \times \tau$ make sense? Why?</p>
<div class="code-block">
  <pre><code class="language-python"></code></pre>
  </div>

<h3>Compute $\Psi_\text{Sv}$ and compare</h3>
<p>Well done so far, you are almost there! 

  The task is now to compare the output barotropic streamfunction <code>ds['psi']</code> to the $\Psi_{Sv}$ calculated from:
  
  \[
  \Psi_{Sv} = \int_{East}^{West}V_{Sv}dx
  \]
  
  <i>Note that the integral goes from East to West, as the boundary wall is placed on the eastern end of the basin.</i><br>
  
  Use the definition of $V_{Sv}$ to compute it from the defined constants and the calculated curl of $\tau$. Then, compute the barotropic stream function $\Psi_{Sv}$ and compare it to the $\Psi$ from the model output by examining their successive plots.</p>
  <div class="code-block">
    <pre><code class="language-python"></code></pre>
    </div>

  <p>It should be noted that mathematically, a reverse integration over a variable (integrating from right to left) is not the same as just flipping the input and calling <code>np.cumsum()</code> — you need to negate the result too.
  Because if you are integrating a function $f(x)$ on a discrete 1D grid with uniform spacing \(\Delta x > 0\), your discrete integral becomes a sum:
  \[
  \int_{x_0}^{x_n} f(x)\,dx \approx \sum_{i=0}^{n-1} f_i \, \Delta x
  \]
  This is equivalent to <code>np.cumsum(f * dx)</code> in NumPy.
Let
<ul>
<li>\(f = [f_0, f_1, f_2, f_3]\)</li>
<li>\(\Delta x > 0\)</li>
</ul>

Then the cumulative integral is:

\(
\text{cumint}[0] = f_0 \Delta x \)<br>
\(\text{cumint}[1] = (f_0 + f_1) \Delta x \)<br>
\(\text{cumint}[2] = (f_0 + f_1 + f_2) \Delta x \)<br>
\(\text{cumint}[3] = (f_0 + f_1 + f_2 + f_3) \Delta x \)<br>

This is what <code>np.cumsum(f * dx)</code> does.

Now suppose you want to integrate right to left (from $x_n$ to $x_0$):

\[
\int_{x_n}^{x_0} f(x)\,dx = - \int_{x_0}^{x_n} f(x)\,dx
\]

If you do

<code>
np.cumsum(f[::-1] * dx)[::-1]
</code>

you're computing the values of integration in reverse order, but the sign is still assuming $x_0 \to x_n$, not $x_n \to x_0$. You’re essentially computing:<br>

\(
\text{bad_reverse}[0] = (f_3) \Delta x \)<br>
\(\text{bad_reverse}[1] = (f_3 + f_2) \Delta x \)<br>
\(\text{bad_reverse}[2] = (f_3 + f_2 + f_1) \Delta x \)<br>
\(\text{bad_reverse}[3] = (f_3 + f_2 + f_1 + f_0) \Delta x\)<br>


Then reversing the array order doesn't fix the fact that this is still a positive integral, just with terms accumulated in reverse.
Because you're still summing the same values — just in reverse. But the limits of integration are reversed, so you must negate the sum to account for this.



To compute the correct integral from $x_n$ to $x_0$

\[
\int_{x_n}^{x_0} f(x)\,dx = -\sum_{i=0}^{n-1} f_i \Delta x
\]

So your NumPy expression must include a negation:

<code>
- np.cumsum(f[::-1] * dx)[::-1]
</code>



<h3>Conclusions</h3>
<ul>
<li>How does the diagnostic streamfunction differ from the one calculated from the Sverdrup balance?</li>

<li>How do these two solutions compare in the open ocean vs. at the boundaries?</li>

<li>How well does this idealized model reflect real winds and ocean currents?</li>
</ul>

<div class="code-block">
  <pre><code class="language-python"></code></pre>
  </div>
<div class="code-block">
  <pre><code class="language-python"></code></pre>
</div>
<div class="code-block">
  <pre><code class="language-python"></code></pre>
</div>






    <p><strong>Next</strong>: <a href="#">To be continued</a></p>

  <div class="footer">
    Qi-fan based on the course material by Markus Jochum & Marta Mrozowska <br>
    It is very much a work in progress! Have you spotted a mistake or an error on this page? 
    Click <a href="mailto:qifan.wu@nbi.ku.dk">here</a> to tell me!<br>
    &copy; 2025 TeamOcean | NBI/KU
  </div>
</div>

  <script>
    function copyToClipboard(btn) {
      const code = btn.nextElementSibling.innerText;
      navigator.clipboard.writeText(code).then(() => {
        btn.classList.add('copied');
        setTimeout(() => btn.classList.remove('copied'), 2000);
      });
    }
  </script>
</body>
</html>